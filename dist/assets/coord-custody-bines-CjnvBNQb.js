import{cd as de,u as ue,bl as me,am as he,t as S,F as M,r as f,dK as xe,dW as U,e9 as H,a6 as pe,j as e,P as fe,M as ge,e as g,f as u,ea as je,X as h,dL as be,dM as ye,dN as Se,H as j,S as ve,dQ as K,dm as _e,D as q,eb as Ce,$ as W,B as m,ec as ke,ed as Be,cw as Y,p as D,dR as Ne,y as we,dT as Ie,Y as Me,z as Fe,aH as v,ee as De,ca as Te}from"./index-zxEALkft.js";import{A as Ae}from"./alerts-BNetvTiV.js";import{a as ze,b as Pe}from"./actionCreator-DtQqcJ92.js";const{Option:$e}=D;function Ue(){const V=[{path:"index",breadcrumbName:de.get("orgName")},{path:"first",breadcrumbName:"Coordinación"}],d=ue();me();let{id:N}=he();const i=S(s=>s.custody.coordination),G=S(s=>s.custody.loading),{bins:T,loading:Q,error:A}=S(s=>s.smBin||{}),{organizationSecurityKits:X}=S(s=>s.bin_drawers||{}),z=S(s=>s.custody.bines),P=S(s=>s.custody.fishingId),[J]=M.useForm(),[l,x]=f.useState({status:"process",isFinished:!1,current:0,showForm:!1,suggestedBinesCount:0,form:{binId:"",binNumber:"",seal1:"",seal2:"",seal3:"",seal4:""},bineForm:{bineIce:"",bineMetabisulfito:""},selectedTreater:void 0}),{treaters:w,treatersLoading:Z}=S(s=>s.bin_drawers||{}),{status:R,isFinished:ee,current:b}=l,[se,_]=f.useState(!1),[o,C]=f.useState([]),[p,k]=f.useState(null),y=T?T.map(s=>(console.log("Bin data:",s),{sm_bin_id:s.id||s.sm_bin_id,id:s.id||s.sm_bin_id,name:s.Name||s.name,Name:s.Name||s.name,nameNumber:parseInt(s.Name||s.name)||0,sm_status:s.sm_status,sm_description:s.sm_description,isactive:s.IsActive?"Y":"N",SM_Fishing_ID:s.SM_Fishing_ID,isOccupied:s.sm_status==="OCUPADO"})).sort((s,a)=>s.nameNumber-a.nameNumber):[];console.log("Normalized bins:",y);const ie=s=>{if(s.sm_status==="OCUPADO")return;if(o.find(n=>n.id===s.id)){C(o.filter(n=>n.id!==s.id)),k(null);return}if(p===null)C([...o,s]),k(s.nameNumber);else{const n=Math.min(p,s.nameNumber),t=Math.max(p,s.nameNumber),I=y.filter(r=>{const c=r.nameNumber;return c>=n&&c<=t&&r.sm_status!=="OCUPADO"&&!o.find(ce=>ce.id===r.id)});C([...o,...I]),k(null)}},E=()=>{C([]),k(null)};f.useEffect(()=>{d(xe(N,()=>{})),d(U(N,(s,a)=>{}))},[d,N]),f.useEffect(()=>{d(H()),d(ze("BIN")),d(Pe())},[d]),f.useLayoutEffect(()=>{const s=document.querySelectorAll(".ant-steps-item-active"),a=document.querySelectorAll(".ant-steps-item-finish");s.forEach(n=>{if(n.previousSibling){const t=n.previousSibling;t.classList.contains("success-step-item")?t.classList.remove("success-step-item"):t.classList.remove("wizard-step-item"),t.classList.add("wizard-steps-item-active")}}),a.forEach(n=>{if(n.previousSibling){const t=n.previousSibling;t.classList.remove("wizard-steps-item-active"),t.classList.add("success-step-item")}})});const B=()=>{let s=0;return i&&(s=Number(Math.ceil(parseFloat(i.fishing_volume)/1200)).toFixed(0)),s},ae=()=>new Promise((s,a)=>{b===0?(x({...l,status:"process",current:b+1}),s()):b===1?le()?J.validateFields().then(()=>{x({...l,status:"process",current:b+1}),s()}).catch(n=>{v.error("Revise los datos requeridos!"),a(n)}):(v.error(`Debe registrar al menos ${B()} bines.`),a()):a()}),ne=()=>new Promise((s,a)=>{b>0?(x({...l,status:"process",current:b-1}),s()):a()}),te=()=>{if(window.confirm("Confirma que desea enviar esta información de Bines?")){const{bineIce:a,bineMetabisulfito:n}=l.bineForm;d(De(P,l.selectedTreater,i.SM_Coordination_ID.id,a,n,t=>{t?x({...l,status:"finish",isFinished:!0,current:0}):v.error("Ocurrió un error al enviar la coordinación.")}))}},L=()=>{x({...l,showForm:!1,form:{...l.form,binId:null,binNumber:null,seal1:null,seal2:null,seal3:null,seal4:null}})},re=()=>{let s=0;return z&&(s=z.length),s},le=()=>re()>=B(),O=[{key:"1",label:"Camaronera:",value:i?i.org_name:"-"},{key:"2",label:"Piscina:",value:i?i.warehouse_name:"-"},{key:"3",label:"Dirección:",value:i?`${i.City} ${i.Address1}, ${i.Address2}`:"-"},{key:"4",label:"Notificación:",value:i?i.SM_FishingNotification:"-"},{key:"5",label:"Fecha de Pesca Confirmada:",value:i?pe(i.answered_date).format("DD-MM-YYYY HH:mm"):"-"},{key:"6",label:"Tipo de Pesca:",value:i?i.fishing_type:"-"},{key:"7",label:"Tipo de Contenedor:",value:i?i.container_type:"-"},{key:"8",label:"Volumen de Pesca:",value:i?`${i.fishing_volume} lbs`:"-"},{key:"9",label:"Clasificación:",value:i?i.Classification:"-"},{key:"10",label:"Textura:",value:i?i.texture:"-"}],F=(()=>{const s=new Set(y.map(r=>r.SM_SecurityKits_ID&&r.SM_SecurityKits_ID.id).filter(r=>r!=null)),n=[...X.filter(r=>!s.has(r.id))],t=new Map;return[...o].sort((r,c)=>r.nameNumber-c.nameNumber).forEach(r=>{if(!t.has(r.id)&&n.length>0){const c=n.shift();t.set(r.id,{key:r.id,bin:r.name,sm_securitykits_id:c.id,sm_kitcode:c.sm_kitcode,seal1:c.SM_Stamp1,seal2:c.SM_Stamp2,seal3:c.SM_Stamp3,seal4:c.SM_Stamp4,sm_tag:c.sm_tag})}}),Array.from(t.values())})(),$=[{title:"No. Bin",dataIndex:"bin",key:"bin"},{title:"Kit de Seguridad",dataIndex:"sm_kitcode",key:"sm_kitcode"},{title:"SM_Stamp1",dataIndex:"seal1",key:"seal1"},{title:"SM_Stamp2",dataIndex:"seal2",key:"seal2"},{title:"SM_Stamp3",dataIndex:"seal3",key:"seal3"},{title:"SM_Stamp4",dataIndex:"seal4",key:"seal4"},{title:"sm_tag",dataIndex:"sm_tag",key:"sm_tag"},{title:"Acciones",key:"actions",render:(s,a)=>e.jsx(m,{type:"danger",icon:e.jsx(Te,{}),onClick:()=>{C(o.filter(n=>n.id!==a.key))},children:"Eliminar"})}],oe=()=>Q?e.jsx("div",{children:"Cargando bines..."}):A?e.jsx(h,{children:e.jsxs("div",{style:{textAlign:"center",padding:"40px"},children:[e.jsx(j,{as:"h4",children:"Error al cargar bines"}),e.jsx("p",{children:A}),e.jsx(m,{onClick:()=>d(H()),children:"Reintentar"})]})}):!y||y.length===0?e.jsx(h,{children:e.jsxs("div",{style:{textAlign:"center",padding:"40px"},children:[e.jsx(j,{as:"h4",children:"No tienes bines creados"}),e.jsx("p",{children:"Debe crear bines primero desde el módulo de inventario."})]})}):e.jsxs("div",{style:{marginBottom:16,textAlign:"center"},children:[e.jsxs(m,{type:"primary",size:"large",onClick:()=>_(!0),children:["Seleccionar Bines (",o.length," seleccionados)"]}),o.length>0&&e.jsx(m,{type:"default",style:{marginLeft:8},onClick:E,children:"Limpiar Selección"})]});return e.jsxs(e.Fragment,{children:[e.jsx(fe,{onBack:()=>window.history.back(),title:`Bines para coordinación: ${i?i.SM_FishingNotification:"-"}`,routes:V}),e.jsx(ge,{children:e.jsx(g,{gutter:25,children:e.jsx(u,{sm:24,xs:24,children:e.jsx(f.Suspense,{fallback:e.jsx(h,{headless:!0,children:e.jsx(Me,{paragraph:{rows:20},active:!0})}),children:e.jsx(je,{children:e.jsx(h,{headless:!0,children:e.jsx(g,{justify:"center",children:e.jsx(u,{xxl:20,xs:24,children:e.jsx(be,{className:"ninjadash-wizard-page",children:e.jsx(ye,{children:e.jsx(Se,{isswitch:!0,current:b,status:R,steps:[{title:"Coordinación",className:"wizard-step-item",icon:e.jsx(_e,{}),content:e.jsx(g,{justify:"center",children:e.jsxs(u,{sm:22,xs:24,children:[e.jsxs(j,{as:"h4",children:["1. Datos de la Coordinación ",G&&e.jsx(ve,{})]}),e.jsx(K,{data:O,pairsPerRow:2})]})})},{title:"Información de Bines",className:"wizard-step-item",icon:e.jsx(Ne,{}),content:e.jsx(q,{className:"basic-form-inner",style:{width:"80%"},children:e.jsx("div",{className:"atbd-form-checkout",children:e.jsx(g,{justify:"center",children:e.jsx(u,{sm:22,xs:24,children:e.jsxs("div",{className:"shipping-form",children:[e.jsx(j,{as:"h4",children:"2. Información de Bines"}),e.jsx("div",{style:{marginBottom:15},children:e.jsx(Ae,{showIcon:!0,icon:e.jsx(Ce,{}),message:"Cantidad de Bines",description:`El volumen de pesca es ${i?i.fishing_volume:""} lbs, cada bin tiene una capacidad máxima de 1200 lbs, para poder enviar la información de esta coordinación necesita registrar al menos un total de ${B()} bin${B()>1?"es":""}.`,type:"info"})}),oe(),o.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:"10px"},children:e.jsx(W,{dataSource:F,columns:$,pagination:!1,title:()=>`Bines Seleccionados (${o.length})`})}),e.jsx("br",{}),e.jsx(g,{justify:"center",gutter:16,style:{marginBottom:15},children:e.jsx(u,{xs:24,sm:24,md:12,lg:12,xl:12,className:"gutter-row",children:e.jsxs("div",{style:{marginBottom:15},children:[e.jsxs(m,{size:"default",type:"primary",onClick:()=>{d(Be(P,F,(s,a)=>{s?(v.success("Los bines se registraron con éxito!"),d(U(N,()=>{L()}))):v.error(a)}))},children:[e.jsx(ke,{}),"Guardar"]}),e.jsx(m,{size:"default",type:"default",onClick:()=>L(),children:"Cancelar"})]})})})]}),e.jsxs(g,{justify:"center",gutter:16,style:{marginBottom:15},children:[e.jsx(u,{xs:24,sm:24,md:12,lg:12,xl:6,className:"gutter-row",children:e.jsx(M.Item,{name:"bineIce",label:"Hielo (#Sacos)",rules:[{required:!0,message:"Por favor ingrese la cantidad de hielo"}],children:e.jsx(Y,{value:l.bineForm.bineIce,onChange:s=>{x({...l,bineForm:{...l.bineForm,bineIce:s}})}})})}),e.jsx(u,{xs:24,sm:24,md:12,lg:12,xl:6,className:"gutter-row",children:e.jsx(M.Item,{name:"bineMetabisulfito",label:"Metabisulfitos (kg)",rules:[{required:!0,message:"Por favor ingrese la cantidad de metabisulfitos"}],children:e.jsx(Y,{value:l.bineForm.bineMetabisulfito,onChange:s=>{x({...l,bineForm:{...l.bineForm,bineMetabisulfito:s}})}})})}),w.length>0?e.jsx(u,{sm:8,xs:24,children:e.jsx(M.Item,{name:"selectedTreater",label:"Seleccionar Tratador",rules:[{required:!0,message:"Por favor seleccione un tratador"}],children:e.jsx(D,{loading:Z,placeholder:"Selecciona un tratador",allowClear:!0,value:l.selectedTreater,onChange:s=>x({...l,selectedTreater:s}),children:w==null?void 0:w.map(s=>e.jsx(D.Option,{value:s.value,children:s==null?void 0:s.label},s==null?void 0:s.value))})})}):null]})]})})})})})},{title:"Resumen",className:"wizard-step-item",icon:e.jsx(Ie,{}),content:R!=="finish"?e.jsxs(q,{style:{width:"100%"},children:[e.jsx(j,{as:"h4",children:"3. Resumen"}),e.jsxs(h,{bodyStyle:{borderRadius:10},headless:!0,children:[e.jsx("div",{className:"atbd-review-order__single",children:e.jsx(h,{headless:!0,children:e.jsxs("div",{className:"atbd-review-order__shippingTitle",children:[e.jsx(j,{as:"h5",children:"Coordinación"}),e.jsx(K,{data:O,pairsPerRow:2})]})})}),e.jsx("div",{className:"atbd-review-order__single",children:e.jsxs(h,{headless:!0,children:[e.jsx("div",{children:e.jsx(j,{as:"h5",children:"Información de Bines"})}),o.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{marginTop:"10px"},children:e.jsx(W,{dataSource:F,columns:$.filter(s=>s.key!=="actions"),pagination:!1})}),e.jsx("br",{})]})]})})]})]}):e.jsx(g,{justify:"center",style:{width:"100%"},children:e.jsx(u,{xl:21,xs:24,children:e.jsx("div",{className:"checkout-successful",children:e.jsx(h,{headless:!0,bodyStyle:{borderRadius:"20px"},children:e.jsxs(h,{headless:!0,children:[e.jsx("span",{className:"icon-success",children:e.jsx(we,{})}),e.jsx(j,{as:"h3",children:"Información de Bines enviada"})]})})})})})}],onNext:ae,onPrev:ne,onDone:te,isfinished:ee})})})})})})})})})})}),e.jsxs(Fe,{title:"Seleccionar Bines",visible:se,onOk:()=>_(!1),onCancel:()=>_(!1),width:1200,footer:[e.jsx(m,{onClick:E,children:"Limpiar Todo"},"clear"),e.jsx(m,{onClick:()=>_(!1),children:"Cancelar"},"cancel"),e.jsxs(m,{type:"primary",onClick:()=>_(!1),children:["Aceptar (",o.length," seleccionados)"]},"ok")],children:[e.jsx("div",{style:{marginBottom:16},children:e.jsxs(g,{justify:"space-between",align:"middle",children:[e.jsx(u,{children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:16},children:[e.jsxs("span",{children:[e.jsx("strong",{children:"Total de Bines:"})," ",y.length]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Seleccionados:"})," ",o.length]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Requeridos:"})," ",B()]})]})}),e.jsx(u,{children:e.jsx(m,{type:p!==null?"primary":"default",onClick:()=>{k(null),v.info(p!==null?"Selección por rango cancelada":"Modo selección individual")},children:p!==null?`Cancelar rango (desde ${p})`:"Modo Individual"})})]})}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(10, 1fr)",gap:"8px",maxHeight:"500px",overflowY:"auto",padding:"16px",border:"1px solid #f0f0f0",borderRadius:"6px",backgroundColor:"#fafafa"},children:y.map(s=>{const a=s.isOccupied,n=o.find(I=>I.id===s.id),t=p===s.nameNumber;return e.jsx(m,{style:{height:"45px",width:"45px",padding:0,backgroundColor:a?"#f5222d":t?"#722ed1":n?"#1890ff":"#52c41a",color:"#fff",border:t?"3px solid #722ed1":"1px solid #d9d9d9",fontWeight:"bold",fontSize:"12px"},disabled:a,onClick:()=>ie(s),title:a?`Bin ocupado - Estado: ${s.sm_status}`:`Bin ${s.name} - ${s.sm_status}`,children:s.name},s.id)})}),e.jsxs("div",{style:{marginTop:16,fontSize:"12px",color:"#666"},children:[e.jsx("p",{children:e.jsx("strong",{children:"Instrucciones:"})}),e.jsxs("ul",{children:[e.jsxs("li",{children:[e.jsx("span",{style:{color:"#52c41a"},children:"■"})," Verde: Disponible"]}),e.jsxs("li",{children:[e.jsx("span",{style:{color:"#1890ff"},children:"■"})," Azul: Seleccionado"]}),e.jsxs("li",{children:[e.jsx("span",{style:{color:"#722ed1"},children:"■"})," Morado: Inicio de rango"]}),e.jsxs("li",{children:[e.jsx("span",{style:{color:"#f5222d"},children:"■"})," Rojo: Ocupado"]})]}),e.jsx("p",{children:"Para selección por rango: clic en el primer bin, luego en el último bin del rango deseado."})]})]})]})}export{Ue as default};
